!function(e,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?exports.module=n():e.module=n()}(this,function(){return function(e){function n(i){if(t[i])return t[i].exports;var r=t[i]={exports:{},id:i,loaded:!1};return e[i].call(r.exports,r,r.exports,n),r.loaded=!0,r.exports}var t={};return n.m=e,n.c=t,n.p="",n(0)}([function(e,n,t){"use strict";function i(e){return e&&e.__esModule?e:{"default":e}}function r(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var o=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},s=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),a=t(1),u=i(a);e.exports=function(){function e(){var n=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return r(this,e),this.CHUNK_SIZE=4096,this.blobs={},this.buffers={},this.events=[],this.peers={},n.dataChannel=n.channel||n.dataChannel,this.options=n,n.wrtc?(this.File=e,this.atob=n.atob,void(this.btoa=n.btoa)):(this.File=window.File,this.atob=window.atob,void(this.btoa=window.btoa))}return s(e,[{key:"_sendChunk",value:function(e,n,t,i){var r={type:"__multi-rtc-blob-chunk__",id:n,content:this.btoa(e)};i&&(r.size=i),this.send(r,t)}},{key:"_sendBlob",value:function(e,n,t){var i=e.content.slice(t,t+this.CHUNK_SIZE);this._sendChunk(i,e.id,n,0===t?e.content.length:!1)}},{key:"_sendFile",value:function(e,n,t){var i=new FileReader;i.onload=function(){this._sendChunk(i.result,e.id,n,0===t?e.content.size:!1)};var r=e.content.slice(t,t+this.CHUNK_SIZE);i.readAsBinaryString(r)}},{key:"add",value:function(e){var n=this,t=arguments.length<=1||void 0===arguments[1]?null:arguments[1];this.peers[e]||(this.peers[e]=new u["default"](o({offerer:null===t},this.options)),this.peers[e].on("signal",this.onSignal.bind(this,e)),this.peers[e].on("add-stream",this.onAddStream.bind(this,e)),this.peers[e].on("channel-open",this.onOpen.bind(this,e)),this.peers[e].on("channel-message",this.onData.bind(this,e)),this.peers[e].on("channel-close",this.onClose.bind(this,e)),this.peers[e].on("channel-error",this.onError.bind(this,e)),this.peers[e].on("channel-buffered-amount-low",this.onBufferedAmountLow.bind(this,e)),this.peers[e].send=function(t){var i=n.peers[e].channel;i&&"open"===i.readyState&&i.send(t)}),t&&this.peers[e].addSignal(t)}},{key:"send",value:function(e,n){var t=n?[n]:Object.keys(this.peers);e=JSON.stringify(e),t.forEach(function(n){this.peers[n].send(e)},this)}},{key:"requireBlob",value:function(e,n){var t=arguments.length<=2||void 0===arguments[2]?0:arguments[2];return this.send({type:"__multi-rtc-blob-chunk__",offset:t,id:n},e)}},{key:"addBlob",value:function(n){var t=this,i=Math.random().toString(32).split(".")[1];return this.blobs[i]={id:i},n instanceof(this.File||e)?(this.blobs[i].content=n,this.blobs[i].send=function(e,n){t._sendFile(t.blobs[i],e,n)},this.blobs[i]):("string"!=typeof n&&(n=JSON.stringify(n)),this.blobs[i].content=n,this.blobs[i].send=function(e,n){t._sendBlob(t.blobs[i],e,n)},this.blobs[i])}},{key:"sendBlob",value:function(e,n){var t=this.addBlob(e),i=n?[n]:Object.keys(this.peers);return i.forEach(function(e){t.send(e,0)},this)}},{key:"onSignal",value:function(e,n){this.trigger("signal",[e,n])}},{key:"onAddStream",value:function(e,n){this.trigger("stream",[e,n])}},{key:"onOpen",value:function(e){this.trigger("connect",[e])}},{key:"onData",value:function(e,n){var t=JSON.parse(n.data);if("__multi-rtc-blob-chunk__"!==t.type)return this.trigger("data",[e,t]);t.offset&&this.blobs[t.id].send(e,t.offset);var i=this.buffers[t.id];i||(i=this.buffers[t.id]={size:t.size,content:""});var r=this.atob(t.content||"");return i.content+=r,this.trigger("partial-blob",[e,i,r]),i.size>i.content.length?this.requireBlob(e,t.id,i.content.length):void this.trigger("data",[e,i.content])}},{key:"onClose",value:function(e){delete this.peers[e],this.trigger("disconnect",[e])}},{key:"onError",value:function(){for(var e=arguments.length,n=Array(e),t=0;e>t;t++)n[t]=arguments[t];this.trigger("error",n)}},{key:"onBufferedAmountLow",value:function(){for(var e=arguments.length,n=Array(e),t=0;e>t;t++)n[t]=arguments[t];this.trigger("buffered-amount-low",n)}},{key:"on",value:function(e,n){this.events[e]=this.events[e]||[],this.events[e].push(n)}},{key:"off",value:function(e,n){if(this.events[e]=this.events[e]||[],n){var t=this.events[e].indexOf(n);return-1!==t&&this.events[e].splice(t,1),-1!==t}this.events[e]=[]}},{key:"trigger",value:function(e){var n=arguments.length<=1||void 0===arguments[1]?[]:arguments[1];this.events[e]=this.events[e]||[],this.events[e].forEach(function(e){e.apply(null,n)})}}]),e}()},function(e,n,t){!function(n,t){e.exports=t()}(this,function(){return function(e){function n(i){if(t[i])return t[i].exports;var r=t[i]={exports:{},id:i,loaded:!1};return e[i].call(r.exports,r,r.exports,n),r.loaded=!0,r.exports}var t={};return n.m=e,n.c=t,n.p="",n(0)}([function(e,n){"use strict";function t(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(n,"__esModule",{value:!0});var i=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),r=function(e){var n="abcdefghijklmnopqrstuvwxyz";n+="ABCDEFGHIJKLMNOPQRSTUVWXYZ",n+="0123456789";for(var t="",i=0;e>i;++i)t+=n[Math.floor((n.length-1)*Math.random())];return t},o=function(){return{RTCPeerConnection:window.RTCPeerConnection||window.msRTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,RTCIceCandidate:window.RTCIceCandidate||window.msRTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate,RTCSessionDescription:window.RTCSessionDescription||window.msRTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription}},s=function(){function e(){var n=this,i=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return t(this,e),i.options=i.options||{iceServers:[]},i.dataChannel&&"boolean"==typeof i.dataChannel&&(i.dataChannel={}),this.stream=i.stream,this.events={signal:[]},this.events["add-stream"]=[],this.events["channel-open"]=[],this.events["channel-message"]=[],this.events["channel-close"]=[],this.events["channel-error"]=[],this.events["channel-buffered-amount-low"]=[],this._signals=[],this.wrtc=i.wrtc||o(),this.wrtc.RTCPeerConnection?(this.peer=new this.wrtc.RTCPeerConnection(i.options),this.peer.onicecandidate=function(e){return e.candidate?n._onSignal(e.candidate):void 0},this.peer.ondatachannel=function(e){n.channel=e.channel,n._bindChannel()},this.peer.onaddstream=function(e){n.stream=e.stream,n.trigger("add-stream",[n.stream])},this.stream&&this.peer.addStream(i.stream),i.offerer?(i.dataChannel&&(this.channel=this.peer.createDataChannel(r(128),i.dataChannel),this._bindChannel()),void this.peer.createOffer(function(e){n.peer.setLocalDescription(e,function(){return n._onSignal(e)},n.onError)},this.onError)):void 0):console.error("No WebRTC support found")}return i(e,[{key:"_bindChannel",value:function(){["open","close","message","error","buffered-amount-low"].forEach(function(e){var n=this;this.channel["on"+e.replace(/-/g,"")]=function(){for(var t=arguments.length,i=Array(t),r=0;t>r;r++)i[r]=arguments[r];n.trigger("channel-"+e,[].concat(i))}},this)}},{key:"_onSignal",value:function(e){return 0===this.events.signal.length?this._signals.push(e):void this.trigger("signal",[e])}},{key:"addSignal",value:function(e){var n=this;return"offer"===e.type?this.peer.setRemoteDescription(new this.wrtc.RTCSessionDescription(e),function(){n.peer.createAnswer(function(e){n.peer.setLocalDescription(e,function(){n._onSignal(e)},n.onError)},n.onError)},this.onError):"answer"===e.type?this.peer.setRemoteDescription(new this.wrtc.RTCSessionDescription(e),function(){},this.onError):void this.peer.addIceCandidate(new this.wrtc.RTCIceCandidate(e),function(){},this.onError)}},{key:"on",value:function(e,n){return void 0===this.events[e]?console.error("MRTC: No such action '"+e+"'"):(this.events[e].push(n),void("signal"===e&&this._signals.forEach(function(e){this.trigger("signal",[e])},this)))}},{key:"off",value:function(e,n){if(n){var t=this.events[e].indexOf(n);return-1!==t&&this.events[e].splice(t,1),-1!==t}this.events[e]=[]}},{key:"trigger",value:function(e,n){n=n||[],this.events[e].forEach(function(e){e.apply(null,n)})}},{key:"onError",value:function(e){console.error(e)}}]),e}();n["default"]=s,e.exports=n["default"]}])})}])});